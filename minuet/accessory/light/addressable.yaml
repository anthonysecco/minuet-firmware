# PACKAGE COLLECTION: MINUET LIGHT ACCESSORY
# VARIANT: ADDRESSABLE LED STRIP
# SUPPORTED HARDWARE: Minuet Light Accessory v3.0
#
# Supports an addressable LED strip connected to the light accessory board.
# Refer to the light accessory documentation for details.
#
# Variables:
#   - Set `minuet_light_accessory_board_version` according to the silkscreen label
#     printed on your light accessory board, e.g. "v3_0".
#   - Set `minuet_led_strip` to one of the keys in the `minuet_light_config` table.
defaults:
  minuet_light_accessory_board_version: "unknown"
  minuet_led_strip: "unknown"

minuet_light:
  substitutions:
    # LED strip configurations.
    # You can add your own configuration here if your strip is different.
    minuet_light_config:
      # BTF Lighting, 12 V, WS2814, RGBW, 60 LEDs per meter, 3 LEDs per pixel
      # Remarks: Bright
      btf_ws2814_rgbw_60:
        num_pixels: 19
        leds_per_meter: 60
        leds_per_pixel: 3
        chipset: WS2811
        rgb_order: RGB
        is_rgbw: false
        is_wrgb: true
        gamma_correct: 1.4
        color_correct: [1, 0.9, 0.9, 1]
      # BTF Lighting, 12 V, SK6812, RGBW, 60 LEDs per meter, 1 LED per pixel
      # Remarks: Ultra bright, unsafe to run all channels at full power (draws 1.7 A and gets too hot)
      btf_sk6812_rgbw_60:
        num_pixels: 57
        leds_per_meter: 60
        leds_per_pixel: 1
        chipset: SK6812
        rgb_order: GRB
        is_rgbw: true
        is_wrgb: false
        gamma_correct: 1.4
        color_correct: [0.6, 0.54, 0.54, 0.6]

    # Calculate the theoretical number of pixels that would fit around the circumference
    # of the fan cowling to form a continuous ring given the LED strip's pixel density.  This value
    # can be used to create animations with rotational symmetry around the fan cowling.
    minuet_light_ring_pixels: ${(0.308 * 3.1415 * minuet_light_config[minuet_led_strip].leds_per_meter / minuet_light_config[minuet_led_strip].leds_per_pixel) | round()}

  # Light component.
  light:
    - id: minuet_light
      name: "Light"
      platform: esp32_rmt_led_strip
      pin: ${minuet_light_pin_data}
      restore_mode: ALWAYS_OFF
      num_leds: ${minuet_light_config[minuet_led_strip].num_pixels}
      chipset: ${minuet_light_config[minuet_led_strip].chipset}
      rgb_order: ${minuet_light_config[minuet_led_strip].rgb_order}
      is_rgbw: ${minuet_light_config[minuet_led_strip].is_rgbw}
      is_wrgb: ${minuet_light_config[minuet_led_strip].is_wrgb}
      gamma_correct: ${minuet_light_config[minuet_led_strip].gamma_correct}
      color_correct: ${minuet_light_config[minuet_led_strip].color_correct}
      power_supply: minuet_light_power
      default_transition_length: 0.5s
      effects:
        - addressable_rainbow:
            width: ${minuet_light_ring_pixels}
        - addressable_twinkle:
        - pulse:
        - lambda:
            name: "Fade"
            update_interval: 20ms
            lambda: |-
              auto color = esphome::light::ESPHSVColor((millis() / 80) & 0xff, 255, 255).to_rgb();
              id(minuet_light).make_call()
                  .set_transition_length(0)
                  .set_color_brightness(1.f)
                  .set_color_mode(esphome::light::ColorMode::RGB_WHITE)
                  .set_rgbw(color.r / 255.f, color.g / 255.f, color.b / 255.f, 0.f)
                  .set_publish(false)
                  .perform();
        - lambda:
            name: "Random"
            update_interval: 7s
            lambda: |-
              auto color = esphome::light::ESPHSVColor(random_uint32() & 0xff, 255, 255).to_rgb();
              id(minuet_light).make_call()
                  .set_transition_length(1000)
                  .set_color_brightness(1.f)
                  .set_color_mode(esphome::light::ColorMode::RGB_WHITE)
                  .set_rgbw(color.r / 255.f, color.g / 255.f, color.b / 255.f, 0.f)
                  .set_publish(false)
                  .perform();
      on_state:
        then:
          lambda: |-
            // Some effects don't clear the white channel when changing colors which makes the
            // effect overly bright so we clear the white channel.
            auto& light = id(minuet_light);
            const auto& values = light->remote_values;
            if (values.get_white() != 0.f) {
              std::string effect = light->get_effect_name();
              if (effect == "Rainbow") {
                ESP_LOGD(minuet::TAG, "Clear white channel for RGBW unaware light effect: %s", effect.c_str());
                static_cast<AddressableLight*>(light->get_output())->all().set_white(0.f);
              }
            }

  # Power supply component turns on the PWR pin when the light is on.
  # Shutdown behavior: The power_supply component automatically turns the light off
  # before ESPHome restarts.
  power_supply:
    - id: minuet_light_power
      pin:
        number: ${minuet_light_pin_power}
        mode: output
      enable_time: 10ms
      keep_on_time: 5s

<<: !include common.yaml
